<!DOCTYPE html>
<html>
<head>
    <title>Create Campaign</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f6f9fc 0%, #eef2f7 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #718096;
            font-size: 1rem;
        }

        .form-container {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #4a5568;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="date"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #2d3748;
            transition: all 0.2s;
            background-color: #f8fafc;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .form-group input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: white;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group .help-text {
            color: #718096;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .form-group .error-message {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }

        .form-group.error input[type="text"],
        .form-group.error textarea,
        .form-group.error select {
            border-color: #e53e3e;
        }

        .form-group.error .error-message {
            display: block;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.2);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            color: #2d3748;
        }

        .preview-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
        }

        .preview-section h2 {
            color: #2d3748;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .preview-card {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .preview-card h3 {
            color: #2d3748;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .preview-card p {
            color: #4a5568;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        @media (max-width: 640px) {
            .container {
                margin: 1rem auto;
            }

            .form-container {
                padding: 1.5rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .form-group input[type="date"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #2d3748;
            transition: all 0.2s;
            background-color: #f8fafc;
            cursor: pointer;
            position: relative;
            padding-right: 2.5rem;
        }

        .form-group input[type="date"]::-webkit-calendar-picker-indicator {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234a5568' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .form-group input[type="date"]:hover::-webkit-calendar-picker-indicator {
            opacity: 1;
        }

        .form-group input[type="date"]:focus::-webkit-calendar-picker-indicator {
            opacity: 1;
        }

        .form-group input[type="date"]::-webkit-datetime-edit {
            padding: 0;
        }

        .form-group input[type="date"]::-webkit-datetime-edit-fields-wrapper {
            padding: 0;
        }

        .form-group input[type="date"]::-webkit-datetime-edit-text {
            color: #4a5568;
        }

        .form-group input[type="date"]::-webkit-datetime-edit-month-field,
        .form-group input[type="date"]::-webkit-datetime-edit-day-field,
        .form-group input[type="date"]::-webkit-datetime-edit-year-field {
            color: #2d3748;
            font-weight: 500;
            padding: 0 0.25rem;
        }

        .form-group input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: white;
        }

        /* Date input placeholder styling */
        .form-group input[type="date"]:invalid::-webkit-datetime-edit {
            color: #a0aec0;
        }

        /* Firefox specific styles */
        .form-group input[type="date"] {
            color-scheme: light;
        }

        .form-group input[type="date"]::-moz-calendar-picker-indicator {
            filter: invert(0.4);
        }

        .form-group input[type="date"]:hover::-moz-calendar-picker-indicator {
            filter: invert(0.6);
        }

        .form-group input[type="date"]:focus::-moz-calendar-picker-indicator {
            filter: invert(0.6);
        }

        .input-group {
            display: flex;
            align-items: center;
        }

        .input-group input {
            flex: 1;
        }

        .input-group .btn {
            white-space: nowrap;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            opacity: 0;
            transform: translateX(100%);
        }

        .notification-banner.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification-banner i {
            font-size: 1.25rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .task-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .task-suggestion {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: all 0.2s ease;
        }

        .task-suggestion.selected {
            background: #edf2f7;
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
        }

        .suggestion-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .suggestion-content i {
            font-size: 1.25rem;
            color: #667eea;
            width: 24px;
            text-align: center;
        }

        .suggestion-text {
            color: #4a5568;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .use-suggestion {
            align-self: flex-end;
            background: #edf2f7;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        .use-suggestion:hover {
            background: #e2e8f0;
            color: #2d3748;
        }

        .task-suggestion:hover {
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
        }

        .duration-suggestions {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            margin-top: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .duration-suggestion {
            flex: 0 0 auto;
            min-width: 150px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: all 0.2s ease;
        }

        .duration-suggestion.selected {
            background: #edf2f7;
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
        }

        .duration-suggestion:hover {
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 640px) {
            .duration-suggestions {
                flex-wrap: wrap;
            }
            
            .duration-suggestion {
                min-width: calc(50% - 0.5rem);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Create New Campaign</h1>
            <p>Set up your referral campaign and start growing your customer base</p>
        </div>

        <div class="form-container">
            <form method="post" id="campaignForm">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="title">Campaign Title</label>
                    <div class="input-group">
                        <input type="text" id="title" name="title" required>
                        <button type="button" id="generateDesc" class="btn btn-secondary" style="margin-left: 0.5rem;">
                            <i class="fas fa-magic"></i>
                            Generate Description
                        </button>
                    </div>
                    <div class="help-text">Give your campaign a clear, memorable name</div>
                    <div class="error-message">Please enter a campaign title</div>
                </div>

                <div class="form-group">
                    <label for="description">Campaign Description</label>
                    <textarea id="description" name="description" required></textarea>
                    <div class="help-text">Describe what makes this campaign special and why customers should participate</div>
                    <div class="error-message">Please enter a campaign description</div>
                </div>

                <div class="form-group" id="taskSuggestionsGroup" style="display: none;">
                    <label>Suggested Rewards</label>
                    <div class="task-suggestions">
                        <div class="task-suggestion" data-type="cash">
                            <div class="suggestion-content">
                                <i class="fas fa-money-bill-wave"></i>
                                <span class="suggestion-text"></span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                        <div class="task-suggestion" data-type="discount">
                            <div class="suggestion-content">
                                <i class="fas fa-percentage"></i>
                                <span class="suggestion-text"></span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                        <div class="task-suggestion" data-type="points">
                            <div class="suggestion-content">
                                <i class="fas fa-star"></i>
                                <span class="suggestion-text"></span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                        <div class="task-suggestion" data-type="gift">
                            <div class="suggestion-content">
                                <i class="fas fa-gift"></i>
                                <span class="suggestion-text"></span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="task">Campaign Reward</label>
                    <select id="task" name="reward_type" required>
                        <option value="">Select a reward type</option>
                        <option value="cash">Cash Reward</option>
                        <option value="discount">Discount Amount</option>
                        <option value="points">Reward Points</option>
                        <option value="gift">Gift Card</option>
                    </select>
                    <div class="help-text">Select the type of reward for this campaign</div>
                    <div class="error-message">Please select a reward type</div>
                </div>

                <div class="form-group" id="amountGroup" style="display: none;">
                    <label for="amount">Reward Amount</label>
                    <div class="input-group">
                        <span class="input-prefix">$</span>
                        <input type="number" 
                               id="amount" 
                               name="reward_amount" 
                               min="0" 
                               step="0.01" 
                               placeholder="0.00"
                               pattern="[0-9]*\.?[0-9]*"
                               inputmode="decimal">
                        <div class="amount-suffix">per referral</div>
                    </div>
                    <div class="help-text">Enter the reward amount for each successful referral</div>
                    <div class="error-message">Please enter a valid amount</div>
                </div>

                <div class="form-group">
                    <label>Task Suggestions</label>
                    <div class="task-suggestions">
                        <div class="task-suggestion" data-type="quiz">
                            <div class="suggestion-content">
                                <i class="fas fa-question-circle"></i>
                                <span class="suggestion-text">Complete a 5-question quiz about our products</span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                        <div class="task-suggestion" data-type="purchase">
                            <div class="suggestion-content">
                                <i class="fas fa-shopping-cart"></i>
                                <span class="suggestion-text">Make a minimum purchase of $50</span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                        <div class="task-suggestion" data-type="event">
                            <div class="suggestion-content">
                                <i class="fas fa-calendar-check"></i>
                                <span class="suggestion-text">Attend our monthly webinar</span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                    </div>
                    <div class="help-text">Choose a suggested task or create your own</div>
                </div>

                <div class="form-group">
                    <label for="task_type">Task Type</label>
                    <select id="task_type" name="task_type" required>
                        <option value="">Select a task type</option>
                        <option value="quiz">Quiz or Trivia</option>
                        <option value="purchase">Make a Purchase</option>
                        <option value="event">Attend an Event</option>
                    </select>
                    <div class="help-text">Select what customers need to do to complete the referral</div>
                    <div class="error-message">Please select a task type</div>
                </div>

                <div class="form-group" id="taskDescriptionGroup" style="display: none;">
                    <label for="task_description">Task Description</label>
                    <textarea id="task_description" name="task_description" placeholder="Describe the task in detail..."></textarea>
                    <div class="help-text">Provide clear instructions for customers to complete the task</div>
                    <div class="error-message">Please enter a task description</div>
                </div>

                <div class="form-group">
                    <label>Campaign Duration</label>
                    <button type="button" id="generateDuration" class="btn btn-secondary">
                        <i class="fas fa-calendar-alt"></i>
                        Get Duration Suggestions
                    </button>
                    <div class="help-text">Choose a suggested duration for your campaign</div>
                </div>

                <div class="form-group" id="durationSuggestionsGroup" style="display: none;">
                    <label>Suggested Duration</label>
                    <div class="duration-suggestions">
                        <div class="duration-suggestion" data-days="7">
                            <div class="suggestion-content">
                                <i class="fas fa-calendar-week"></i>
                                <span class="suggestion-text">7 Days</span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                        <div class="duration-suggestion" data-days="10">
                            <div class="suggestion-content">
                                <i class="fas fa-calendar-alt"></i>
                                <span class="suggestion-text">10 Days</span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                        <div class="duration-suggestion" data-days="15">
                            <div class="suggestion-content">
                                <i class="fas fa-calendar"></i>
                                <span class="suggestion-text">15 Days</span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                        <div class="duration-suggestion" data-days="30">
                            <div class="suggestion-content">
                                <i class="fas fa-calendar-check"></i>
                                <span class="suggestion-text">30 Days</span>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm use-suggestion">
                                <i class="fas fa-check"></i> Use This
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="start_date">Start Date</label>
                    <input type="date" id="start_date" name="start_date" required min="">
                    <div class="help-text">When should the campaign begin?</div>
                    <div class="error-message">Please select a start date</div>
                </div>

                <div class="form-group">
                    <label for="end_date">End Date</label>
                    <input type="date" id="end_date" name="end_date" required min="">
                    <div class="help-text">When should the campaign end?</div>
                    <div class="error-message">Please select an end date</div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i>
                        Create Campaign
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                </div>
            </form>

            <div class="preview-section">
                <h2>Campaign Preview</h2>
                <div class="preview-card">
                    <h3 id="preview-title">Campaign Title</h3>
                    <p id="preview-description">Campaign description will appear here...</p>
                    <p id="preview-dates">Duration: <span id="preview-dates-value"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script>
        // Define all required variables at the beginning
        const taskSelect = document.getElementById('task');
        const amountInput = document.getElementById('amount');
        const amountGroup = document.getElementById('amountGroup');
        const generateDescBtn = document.getElementById('generateDesc');
        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const form = document.getElementById('campaignForm');
        const inputs = form.querySelectorAll('input, textarea, select');
        const previewTitle = document.getElementById('preview-title');
        const previewDescription = document.getElementById('preview-description');
        const previewDatesValue = document.getElementById('preview-dates-value');

        // Add new variable for generate duration button
        const generateDurationBtn = document.getElementById('generateDuration');
        const durationSuggestionsGroup = document.getElementById('durationSuggestionsGroup');

        // Add new variables for task type handling
        const taskTypeSelect = document.getElementById('task_type');
        const taskDescriptionGroup = document.getElementById('taskDescriptionGroup');
        const taskDescriptionInput = document.getElementById('task_description');

        // Set minimum date to today for both date inputs
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('start_date').min = today;
        document.getElementById('end_date').min = today;

        // Update end date minimum when start date changes
        document.getElementById('start_date').addEventListener('change', function() {
            document.getElementById('end_date').min = this.value;
            if (document.getElementById('end_date').value && 
                document.getElementById('end_date').value < this.value) {
                document.getElementById('end_date').value = this.value;
            }
        });

        // Add event listener for generate duration button
        generateDurationBtn.addEventListener('click', function() {
            durationSuggestionsGroup.style.display = 'block';
        });

        // Handle duration suggestion clicks
        document.querySelectorAll('#durationSuggestionsGroup .use-suggestion').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const suggestion = this.closest('.duration-suggestion');
                const days = parseInt(suggestion.dataset.days);
                
                // Set start date to today
                const startDate = new Date();
                document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
                
                // Calculate end date
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + days);
                document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
                
                // Highlight the selected suggestion
                document.querySelectorAll('#durationSuggestionsGroup .duration-suggestion').forEach(s => {
                    s.classList.remove('selected');
                });
                suggestion.classList.add('selected');
                
                updatePreview();
            });
        });

        // Handle reward suggestion clicks
        document.querySelectorAll('#taskSuggestionsGroup .use-suggestion').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const suggestion = this.closest('.task-suggestion');
                const type = suggestion.dataset.type;
                const text = suggestion.querySelector('.suggestion-text').textContent;
                
                // Update reward type dropdown
                taskSelect.value = type;
                
                // Extract amount from text
                const amountMatch = text.match(/\$(\d+\.?\d*)/) || text.match(/(\d+)%/);
                if (amountMatch) {
                    amountInput.value = amountMatch[1];
                    amountGroup.style.display = 'block';
                    amountInput.required = true;
                }
                
                // Highlight the selected suggestion
                document.querySelectorAll('#taskSuggestionsGroup .task-suggestion').forEach(s => {
                    s.classList.remove('selected');
                });
                suggestion.classList.add('selected');
                
                updatePreview();
            });
        });

        // Handle task suggestion clicks
        document.querySelectorAll('.task-suggestions .use-suggestion').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const suggestion = this.closest('.task-suggestion');
                const type = suggestion.dataset.type;
                const text = suggestion.querySelector('.suggestion-text').textContent;
                
                // Update task type dropdown
                taskTypeSelect.value = type;
                
                // Update task description
                taskDescriptionInput.value = text;
                taskDescriptionGroup.style.display = 'block';
                
                // Highlight the selected suggestion
                document.querySelectorAll('.task-suggestions .task-suggestion').forEach(s => {
                    s.classList.remove('selected');
                });
                suggestion.classList.add('selected');
                
                updatePreview();
            });
        });

        // Handle task type selection
        taskTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            if (selectedType) {
                taskDescriptionGroup.style.display = 'block';
            } else {
                taskDescriptionGroup.style.display = 'none';
            }
            updatePreview();
        });

        // Handle reward type selection
        taskSelect.addEventListener('change', function() {
            const selectedType = this.value;
            if (selectedType) {
                amountGroup.style.display = 'block';
                amountInput.required = true;
            } else {
                amountGroup.style.display = 'none';
                amountInput.required = false;
            }
            updatePreview();
        });

        // Update the generate description functionality
        generateDescBtn.addEventListener('click', async function() {
            const title = titleInput.value.trim();
            if (!title) {
                alert('Please enter a campaign title first');
                return;
            }

            // Show loading state
            generateDescBtn.classList.add('loading');
            generateDescBtn.innerHTML = '<i class="fas fa-spinner"></i> Generating...';

            try {
                const prompt = `Generate a compelling campaign description and task suggestions for a referral program with the title "${title}". 
                The response should be in JSON format with two fields:
                1. "description": A compelling description that highlights the benefits, rewards, and why customers should participate. Keep it concise and engaging.
                2. "task_suggestions": An object with 4 task suggestions in the following format:
                   {
                     "cash": "Cash reward of $X for each successful referral",
                     "discount": "X% discount on next purchase for each successful referral",
                     "points": "X reward points for each successful referral",
                     "gift": "Gift card worth $X for each successful referral"
                   }
                Make the amounts reasonable and attractive for customers.`;
                
                const response = await fetch('{% url "generate_ai_response" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        type: 'campaign'
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.response) {
                    try {
                        const parsedResponse = data.response;
                        
                        // Update description
                        descriptionInput.value = parsedResponse.description;
                        
                        // Update task suggestions
                        const taskSuggestions = parsedResponse.task_suggestions;
                        const suggestionsGroup = document.getElementById('taskSuggestionsGroup');
                        suggestionsGroup.style.display = 'block';
                        
                        // Update each suggestion
                        Object.entries(taskSuggestions).forEach(([type, text]) => {
                            const suggestion = suggestionsGroup.querySelector(`[data-type="${type}"]`);
                            if (suggestion) {
                                suggestion.querySelector('.suggestion-text').textContent = text;
                            }
                        });
                        
                        updatePreview();
                    } catch (parseError) {
                        console.error('Error parsing AI response:', parseError);
                        alert('Failed to parse the response. Please try again.');
                    }
                } else {
                    throw new Error('No response from API');
                }
            } catch (error) {
                console.error('Error generating content:', error);
                alert('Failed to generate content. Please try again.');
            } finally {
                // Reset button state
                generateDescBtn.classList.remove('loading');
                generateDescBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Description';
            }
        });

        // Update the preview function to include reward information
        function updatePreview() {
            const title = titleInput.value || 'Campaign Title';
            const description = descriptionInput.value || 'Campaign description will appear here...';
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const taskType = taskTypeSelect.value;
            const taskDescription = taskDescriptionInput.value;
            const rewardType = taskSelect.value;
            const rewardAmount = amountInput.value;

            previewTitle.textContent = title;
            previewDescription.textContent = description;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const formattedStart = start.toLocaleDateString('en-US', options);
                const formattedEnd = end.toLocaleDateString('en-US', options);
                document.getElementById('preview-dates-value').textContent = `${formattedStart} - ${formattedEnd}`;
            } else {
                document.getElementById('preview-dates-value').textContent = 'Not specified';
            }

            // Update reward preview if available
            if (rewardType && rewardAmount) {
                const rewardPreview = document.createElement('p');
                rewardPreview.className = 'preview-reward';
                rewardPreview.innerHTML = `<strong>Reward:</strong> ${rewardType.charAt(0).toUpperCase() + rewardType.slice(1)} reward of $${rewardAmount}`;
                const existingRewardPreview = document.querySelector('.preview-reward');
                if (existingRewardPreview) {
                    existingRewardPreview.remove();
                }
                document.querySelector('.preview-card').appendChild(rewardPreview);
            }

            // Update task preview if available
            if (taskType && taskDescription) {
                const taskPreview = document.createElement('p');
                taskPreview.className = 'preview-task';
                taskPreview.innerHTML = `<strong>Task:</strong> ${taskDescription}`;
                const existingTaskPreview = document.querySelector('.preview-task');
                if (existingTaskPreview) {
                    existingTaskPreview.remove();
                }
                document.querySelector('.preview-card').appendChild(taskPreview);
            }
        }

        inputs.forEach(input => {
            input.addEventListener('input', updatePreview);
        });

        // Form validation
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent immediate form submission
            
            let isValid = true;
            inputs.forEach(input => {
                const formGroup = input.closest('.form-group');
                if (formGroup) {  // Check if formGroup exists
                    if (!input.value.trim()) {
                        formGroup.classList.add('error');
                        isValid = false;
                    } else {
                        formGroup.classList.remove('error');
                    }
                }
            });

            if (!isValid) {
                alert('Please fill in all required fields');
            } else {
                // Show notification
                showNotification('All your customers have been sent an email regarding the campaign');
                
                // Submit the form after a short delay
                setTimeout(() => {
                    form.submit();
                }, 1000);
            }
        });

        function showNotification(message) {
            const banner = document.createElement('div');
            banner.className = 'notification-banner';
            banner.innerHTML = `
                <i class="fas fa-envelope"></i>
                ${message}
            `;
            document.body.appendChild(banner);

            // Show the banner
            setTimeout(() => banner.classList.add('show'), 100);

            // Hide and remove after 5 seconds
            setTimeout(() => {
                banner.classList.remove('show');
                setTimeout(() => banner.remove(), 300);
            }, 5000);
        }

        // Check for stored campaign data
        document.addEventListener('DOMContentLoaded', function() {
            const storedData = sessionStorage.getItem('aiCampaignData');
            if (storedData) {
                const campaignData = JSON.parse(storedData);
                
                // Populate form fields
                document.getElementById('title').value = campaignData.campaignTitle || '';
                document.getElementById('description').value = campaignData.description || '';
                var rewardType = {
                    'Cash Reward': 'cash',
                    'Discount Amount': 'discount',
                    'Reward Points': 'points',
                    'Gift Card': 'gift'
                }
                document.getElementById('task').value = rewardType[campaignData.rewardType];
                // document.getElementById('duration').value = campaignData.duration.split(' ')[0];
                
                days = campaignData.duration.split(' ')[0];
                const startDate = new Date();
                document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
                
                // Calculate end date
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + days);
                document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
                // Clear the stored data after populating
                sessionStorage.removeItem('aiCampaignData');
            }
        });
    </script>
</body>
</html>